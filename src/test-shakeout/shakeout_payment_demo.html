<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shake-out Payment Demo - BOOKIFAY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }

        .section.active {
            border-color: #28a745;
            background: #f8fff9;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .step-number {
            background: #28a745;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        .step-number.completed {
            background: #20c997;
        }

        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px 10px 5px 0;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: #20c997;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.warning {
            background: #ffc107;
            color: #333;
        }

        .info-box {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pill-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .detail-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .detail-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 16px;
            color: #333;
            margin-top: 5px;
        }

        .payment-url {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
        }

        .logs {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-success { background: rgba(72, 187, 120, 0.2); }
        .log-error { background: rgba(245, 101, 101, 0.2); }
        .log-info { background: rgba(66, 153, 225, 0.2); }
        .log-warning { background: rgba(237, 137, 54, 0.2); }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-pending { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }

        @media (max-width: 768px) {
            .pill-details {
                grid-template-columns: 1fr;
            }

            .container {
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Shake-out Payment Demo</h1>
            <p>Testing integration with Shake-out payment gateway</p>
            <small>Webhook URL: https://api2.bookefay.com/api/webhook/shakeout/</small>
        </div>
        <div class="content">
            <!-- Step 1: Load Pill Data -->
            <div class="section" id="step1">
                <h3>
                    <span class="step-number" id="step1-num">1</span>
                    Load Pill Data
                </h3>
                <p>First, load the pill data to verify the payment status and details.</p>
                <button class="btn" onclick="loadPillData()" id="load-pill-btn">
                    <span id="load-loading" class="loading" style="display: none;"></span>
                    Load Pill #30
                </button>
                <div id="pill-data" style="display: none;">
                    <h4>Pill Details</h4>
                    <div class="pill-details" id="pill-details">
                        <!-- Pill details will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Step 2: Create Shake-out Invoice -->
            <div class="section" id="step2">
                <h3>
                    <span class="step-number" id="step2-num">2</span>
                    Create Shake-out Invoice
                </h3>
                <p>Create a payment invoice for the pill using the Shake-out payment service.</p>
                <button class="btn" onclick="createShakeoutInvoice()" id="create-payment-btn" disabled>
                    <span id="create-loading" class="loading" style="display: none;"></span>
                    Create Shake-out Invoice
                </button>
                <button class="btn success" onclick="openPaymentUrl()" id="open-payment-btn" disabled>
                    Open Payment Page
                </button>
                <div id="payment-invoice-data" style="display: none;">
                    <h4>Shake-out Invoice Created</h4>
                    <div class="success-box">
                        <p><strong>Invoice ID:</strong> <span id="invoice-id"></span></p>
                        <p><strong>Invoice Reference:</strong> <span id="invoice-ref"></span></p>
                        <p><strong>Total Amount:</strong> <span id="invoice-amount"></span> EGP</p>
                    </div>
                    <p>Payment URL:</p>
                    <div class="payment-url" id="payment-url"></div>
                </div>
            </div>

            <!-- Step 3: Payment Status Monitoring -->
            <div class="section" id="step3">
                <h3>
                    <span class="step-number" id="step3-num">3</span>
                    Payment Status Monitoring
                </h3>
                <p>Check the payment status and monitor for webhook updates from Shake-out.</p>
                <button class="btn" onclick="checkPaymentStatus()" id="check-status-btn" disabled>
                    <span id="status-loading" class="loading" style="display: none;"></span>
                    Check Payment Status
                </button>
                <button class="btn success" onclick="simulateWebhook('paid')" id="webhook-success-btn" disabled>
                    Simulate Paid Webhook
                </button>
                <button class="btn danger" onclick="simulateWebhook('failed')" id="webhook-failed-btn" disabled>
                    Simulate Failed Webhook
                </button>
                <div id="payment-status-data" style="display: none;">
                    <div class="info-box" id="status-box">
                        <div id="status-content"></div>
                    </div>
                </div>
            </div>

            <!-- Logs Container -->
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <script>
        // Configuration for Shake-out testing - FIXED with valid pill ID
        const CONFIG = {
            baseUrl: 'http://127.0.0.1:8000',  // Fixed: Use correct Django port
            jwtToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzU0NjAzMDQ4LCJpYXQiOjE3NTQzNDM4NDgsImp0aSI6IjhhYTJkNjBjZGEwMTQ5ZThhZWUwNGY5OGZmNzkzNTJlIiwidXNlcl9pZCI6MX0.Na6rwmqH_z8hkrHER7xId7gxp-T-DiRG8vlAsgCjdCg',  // Fresh JWT token
            pillId: 32,  // Valid pill ID that belongs to the admin user
            pillNumber: '18550971531093727412'  // Matching pill number
        };

        // Global state
        let pillData = null;
        let shakeoutData = null;

        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'auth': `Bearer ${CONFIG.jwtToken}`
            };
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;

            const logsContainer = document.getElementById('logs');
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function showLoading(elementId, show = true) {
            const element = document.getElementById(elementId);
            element.style.display = show ? 'inline-block' : 'none';
        }

        function setStepCompleted(stepNum) {
            const stepElement = document.getElementById(`step${stepNum}-num`);
            stepElement.classList.add('completed');
            stepElement.innerHTML = '‚úì';
        }

        function activateStep(stepNum) {
            document.getElementById(`step${stepNum}`).classList.add('active');
        }

        // Step 1: Load Pill Data
        async function loadPillData() {
            showLoading('load-loading', true);
            log('Loading pill data...', 'info');

            try {
                const response = await fetch(`${CONFIG.baseUrl}/pills/${CONFIG.pillId}/`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                pillData = await response.json();
                log(`‚úì Pill data loaded successfully`, 'success');
                log(`Items: ${pillData.items?.length || 0}, Amount: ${pillData.final_price} EGP`, 'info');

                // Display pill data
                displayPillData(pillData);

                // Enable next step
                document.getElementById('create-payment-btn').disabled = false;
                setStepCompleted(1);
                activateStep(2);

            } catch (error) {
                log(`‚úó Error loading pill data: ${error.message}`, 'error');
                showErrorBox('step1', `Failed to load pill data: ${error.message}`);
            } finally {
                showLoading('load-loading', false);
            }
        }

        function displayPillData(data) {
            const container = document.getElementById('pill-details');
            container.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Pill Number</div>
                    <div class="detail-value">${data.pill_number}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total Amount</div>
                    <div class="detail-value">${data.final_price} EGP</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Payment Status</div>
                    <div class="detail-value">
                        <span class="status-indicator ${data.paid ? 'status-success' : 'status-pending'}"></span>
                        ${data.paid ? 'PAID' : 'UNPAID'}
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Customer</div>
                    <div class="detail-value">${data.pilladdress?.name || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Items Count</div>
                    <div class="detail-value">${data.items?.length || 0} items</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Shake-out Status</div>
                    <div class="detail-value">${data.shakeout_payment_status || 'No invoice'}</div>
                </div>
            `;
            document.getElementById('pill-data').style.display = 'block';
        }

        // Step 2: Create Shake-out Invoice
        async function createShakeoutInvoice() {
            showLoading('create-loading', true);
            log('Creating Shake-out invoice...', 'info');

            try {
                // Call the pill's create_shakeout_invoice method
                const response = await fetch(`${CONFIG.baseUrl}/pills/${CONFIG.pillId}/create-shakeout-invoice/`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    shakeoutData = result.data;
                    log(`‚úì Shake-out invoice created successfully`, 'success');
                    log(`Invoice ID: ${shakeoutData.invoice_id}`, 'info');
                    log(`Payment URL: ${shakeoutData.payment_url}`, 'info');

                    // Display invoice data
                    document.getElementById('invoice-id').textContent = shakeoutData.invoice_id;
                    document.getElementById('invoice-ref').textContent = shakeoutData.invoice_ref;
                    document.getElementById('invoice-amount').textContent = shakeoutData.total_amount;
                    document.getElementById('payment-url').textContent = shakeoutData.payment_url;
                    document.getElementById('payment-invoice-data').style.display = 'block';

                    // Enable next steps
                    document.getElementById('open-payment-btn').disabled = false;
                    document.getElementById('check-status-btn').disabled = false;
                    document.getElementById('webhook-success-btn').disabled = false;
                    document.getElementById('webhook-failed-btn').disabled = false;

                    setStepCompleted(2);
                    activateStep(3);

                } else {
                    throw new Error(result.error || result.message || 'Failed to create Shake-out invoice');
                }

            } catch (error) {
                log(`‚úó Error creating Shake-out invoice: ${error.message}`, 'error');
                showErrorBox('step2', `Failed to create Shake-out invoice: ${error.message}`);
            } finally {
                showLoading('create-loading', false);
            }
        }

        function openPaymentUrl() {
            if (shakeoutData?.payment_url) {
                window.open(shakeoutData.payment_url, '_blank');
                log('üì± Opened Shake-out payment URL in new tab', 'info');
                log('üí≥ Complete the payment and return here to check status', 'info');
            } else {
                log('‚ùå No payment URL available', 'error');
            }
        }

        // Step 3: Payment Status Monitoring
        async function checkPaymentStatus() {
            showLoading('status-loading', true);
            log('Checking payment status...', 'info');

            try {
                const response = await fetch(`${CONFIG.baseUrl}/pills/${CONFIG.pillId}/`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                displayPaymentStatus(result);

                if (result.paid) {
                    log(`‚úÖ Payment confirmed!`, 'success');
                    setStepCompleted(3);
                } else {
                    log(`‚è≥ Payment still pending`, 'warning');
                }

            } catch (error) {
                log(`‚úó Error checking payment status: ${error.message}`, 'error');
            } finally {
                showLoading('status-loading', false);
            }
        }

        function displayPaymentStatus(data) {
            const statusBox = document.getElementById('status-box');
            const isPaid = data.paid;

            statusBox.className = `info-box ${isPaid ? 'success-box' : 'warning-box'}`;

            document.getElementById('status-content').innerHTML = `
                <strong>Payment Status: ${isPaid ? '‚úÖ PAID' : '‚è≥ PENDING'}</strong><br>
                <strong>Pill Number:</strong> ${data.pill_number}<br>
                <strong>Status:</strong> ${data.status}<br>
                <strong>Final Price:</strong> ${data.final_price} EGP<br>
                <strong>Shake-out Status:</strong> ${data.shakeout_payment_status || 'No invoice'}<br>
                ${data.shakeout_invoice_id ? `<strong>Invoice ID:</strong> ${data.shakeout_invoice_id}<br>` : ''}
                <strong>Last Checked:</strong> ${new Date().toLocaleString()}
            `;

            document.getElementById('payment-status-data').style.display = 'block';
        }

        // Webhook Simulation
        async function simulateWebhook(status) {
            log(`Simulating ${status} webhook...`, 'info');

            if (!shakeoutData) {
                log('‚ùå No Shake-out invoice data available for webhook simulation', 'error');
                return;
            }

            const webhookData = {
                type: "InvoiceStatusUpdated",
                data: {
                    invoice_id: shakeoutData.invoice_id,
                    invoice_ref: shakeoutData.invoice_ref,
                    payment_method: "credit_card",
                    invoice_status: status,
                    amount: parseFloat(shakeoutData.total_amount),
                    referenceNumber: `REF_${Date.now()}`,
                    updated_at: new Date().toISOString()
                }
            };

            // Calculate signature for webhook validation
            const signatureString = webhookData.data.invoice_id + 
                                  webhookData.data.amount + 
                                  webhookData.data.invoice_status + 
                                  webhookData.data.updated_at + 
                                  "9aa639b63b2a4c3182f73771fb2e11df"; // SECRET_KEY

            // Simple SHA-256 simulation (in real implementation, use proper library)
            webhookData.signature = btoa(signatureString).slice(0, 64);

            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/webhook/shakeout/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    log(`‚úÖ ${status.toUpperCase()} webhook processed successfully`, 'success');
                    showSuccessBox('step3', `Webhook processed: Payment ${status} for pill ${result.pill_number}`);

                    // Check status after webhook
                    setTimeout(checkPaymentStatus, 1000);

                } else {
                    throw new Error(result.error || 'Webhook processing failed');
                }

            } catch (error) {
                log(`‚úó Error processing ${status} webhook: ${error.message}`, 'error');
            }
        }

        // Helper functions for displaying messages
        function showSuccessBox(stepId, message) {
            showMessageBox(stepId, message, 'success-box');
        }

        function showErrorBox(stepId, message) {
            showMessageBox(stepId, message, 'error-box');
        }

        function showMessageBox(stepId, message, className) {
            const step = document.getElementById(stepId);
            let messageBox = step.querySelector('.message-box');

            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.className = 'message-box';
                step.appendChild(messageBox);
            }

            messageBox.className = `info-box ${className}`;
            messageBox.innerHTML = message;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Shake-out Payment Demo initialized', 'info');
            log(`Base URL: ${CONFIG.baseUrl}`, 'info');
            log(`Testing Pill ID: ${CONFIG.pillId}`, 'info');  
            log(`Webhook URL: https://api2.bookefay.com/api/webhook/shakeout/`, 'info');
            log('Click "Load Pill #30" to start the demo', 'info');
        });
    </script>
</body>
</html>